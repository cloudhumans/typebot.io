---
phase: 04-schema-validation-and-performance
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/lib/scripts/verify-trace-injection.ts
  - .planning/PROJECT.md
autonomous: true
requirements: [VAL-03]

must_haves:
  truths:
    - "The dd.trace_id injection status is empirically confirmed by running a child-process script"
    - "The result (present or absent, and why) is documented in PROJECT.md Key Decisions table"
    - "The STATE.md blocker about dd.trace_id is resolved"
  artifacts:
    - path: "packages/lib/scripts/verify-trace-injection.ts"
      provides: "One-time verification script for dd.trace_id injection"
      min_lines: 15
    - path: ".planning/PROJECT.md"
      provides: "Updated Key Decisions with dd.trace_id status"
      contains: "dd.trace_id"
  key_links:
    - from: "packages/lib/scripts/verify-trace-injection.ts"
      to: "packages/lib/trpc/datadogInit.ts"
      via: "require and call ensureDatadogInitialized"
      pattern: "ensureDatadogInitialized"
---

<objective>
Confirm dd.trace_id injection status and document the finding in PROJECT.md.

Purpose: VAL-03 resolves the STATE.md blocker about dd.trace_id injection on non-tRPC paths. This is a one-time empirical verification, not a regression test.
Output: Verification script, updated PROJECT.md Key Decisions, resolved STATE.md blocker.
</objective>

<execution_context>
@/home/giordanowt/.claude/get-shit-done/workflows/execute-plan.md
@/home/giordanowt/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-schema-validation-and-performance/04-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create and run dd.trace_id verification script (VAL-03)</name>
  <files>packages/lib/scripts/verify-trace-injection.ts</files>
  <action>
Create `packages/lib/scripts/` directory and `verify-trace-injection.ts`.

The script uses the established tsx child-process pattern to test two scenarios:

**Scenario A — dd-trace initialized BEFORE logger (correct order):**
```typescript
const scriptA = [
  `const { ensureDatadogInitialized } = require('./packages/lib/trpc/datadogInit');`,
  `ensureDatadogInitialized();`,
  `const logger = require('./packages/lib/logger').default;`,
  `logger.info('trace probe A');`,
].join(' ')
```
Run via `spawnSync(tsxBin, ['-e', scriptA], ...)` with `DD_LOGS_ENABLED=true`, `NODE_ENV=production`.
Parse stdout JSON. Check whether `dd` key exists in the output.

**Scenario B — logger loaded WITHOUT dd-trace init (background job path):**
```typescript
const scriptB = [
  `const logger = require('./packages/lib/logger').default;`,
  `logger.info('trace probe B');`,
].join(' ')
```
Run same way. Check whether `dd` key exists.

Print results to stdout:
```
Scenario A (dd-trace before logger): dd key present = true/false
Scenario B (logger without dd-trace): dd key present = true/false
```

IMPORTANT: Do NOT assert `dd.trace_id` is non-zero. In a standalone script with no active span, trace_id will be `0` even with correct injection. Only check whether the `dd` key is present (indicating the monkey-patch was applied).

Run the script: `npx tsx packages/lib/scripts/verify-trace-injection.ts`

Capture the output. The expected result per RESEARCH and STATE.md:
- Scenario A: `dd` key present (monkey-patch applied)
- Scenario B: `dd` key absent (no dd-trace init = no monkey-patch)
  </action>
  <verify>
    <automated>cd /home/giordanowt/Repositories/typebot.io && npx tsx packages/lib/scripts/verify-trace-injection.ts 2>&1</automated>
  </verify>
  <done>Script runs successfully and prints dd.trace_id injection status for both scenarios</done>
</task>

<task type="auto">
  <name>Task 2: Document dd.trace_id status in PROJECT.md and resolve STATE.md blocker</name>
  <files>.planning/PROJECT.md, .planning/STATE.md</files>
  <action>
Based on the verification script output from Task 1:

1. **Update `.planning/PROJECT.md` Key Decisions table** — add a new row:
   - Decision: `dd.trace_id injection is present when dd-trace is initialized before Winston (tRPC request paths); absent on non-tRPC paths (background jobs) where dd-trace lazy init has not run. This is a pre-existing limitation. Primary log correlation uses workflow.id/execution_id which is always present.`
   - Phase: `Phase 4`
   - Rationale: `Empirically confirmed via verify-trace-injection.ts — dd key present in Scenario A (dd-trace first), absent in Scenario B (no dd-trace init)`

2. **Update `.planning/STATE.md`** — remove the Phase 4 blocker entry about dd.trace_id from the Blockers/Concerns section. Replace with `None.` or remove the line entirely.

3. **Update `.planning/STATE.md`** current position to reflect Phase 4 progress.

Read both files before editing to preserve existing content.
  </action>
  <verify>
    <automated>grep -c "dd.trace_id" /home/giordanowt/Repositories/typebot.io/.planning/PROJECT.md</automated>
    <manual>PROJECT.md Key Decisions contains the dd.trace_id finding; STATE.md blocker is resolved</manual>
  </verify>
  <done>PROJECT.md Key Decisions documents dd.trace_id injection status with empirical evidence. STATE.md blocker about dd.trace_id is removed.</done>
</task>

</tasks>

<verification>
1. Verification script runs without error: `npx tsx packages/lib/scripts/verify-trace-injection.ts`
2. PROJECT.md contains dd.trace_id decision: `grep "dd.trace_id" .planning/PROJECT.md`
3. STATE.md no longer has dd.trace_id blocker: `grep -c "dd.trace_id" .planning/STATE.md` returns 0
</verification>

<success_criteria>
- verify-trace-injection.ts exists and runs successfully
- dd.trace_id injection status empirically confirmed for both tRPC and non-tRPC paths
- PROJECT.md Key Decisions updated with the finding
- STATE.md Phase 4 blocker resolved
</success_criteria>

<output>
After completion, create `.planning/phases/04-schema-validation-and-performance/04-02-SUMMARY.md`
</output>

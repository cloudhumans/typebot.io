---
phase: 01-logger-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/env/env.ts
  - packages/lib/logger.ts
autonomous: true
requirements:
  - LOG-01
  - LOG-02
  - LOG-03

must_haves:
  truths:
    - "Setting DD_LOGS_ENABLED=true NODE_ENV=production produces single-line JSON on stdout"
    - "Every log entry contains top-level ddsource: nodejs and service: typebot-runner fields"
    - "Starting the app with DD_LOGS_ENABLED=invalid causes a startup error from Zod validation"
    - "DD_LOGS_ENABLED and LOG_LEVEL are present in the Zod env schema server block"
  artifacts:
    - path: "packages/env/env.ts"
      provides: "Zod validation for DD_LOGS_ENABLED, LOG_LEVEL, DD_SERVICE"
      contains: "DD_LOGS_ENABLED"
    - path: "packages/lib/logger.ts"
      provides: "Winston logger with defaultMeta for static DD fields"
      contains: "defaultMeta"
  key_links:
    - from: "packages/env/env.ts"
      to: "packages/lib/logger.ts"
      via: "Independent validation -- env.ts validates at startup, logger.ts reads raw process.env at instantiation"
      pattern: "DD_LOGS_ENABLED"
---

<objective>
Add Datadog static fields to the Winston logger via defaultMeta and add DD_LOGS_ENABLED, LOG_LEVEL, and DD_SERVICE to the Zod env schema so misconfigured values fail at startup.

Purpose: The logger must emit schema-compliant JSON with ddsource and service on every entry (required by the DD pipeline parser), and env var typos must crash the app at startup rather than silently producing colorized text that the DD Agent cannot parse.

Output: Modified packages/env/env.ts with three new server-side env vars, and modified packages/lib/logger.ts with defaultMeta containing ddsource and service.
</objective>

<execution_context>
@/home/giordanowt/.claude/get-shit-done/workflows/execute-plan.md
@/home/giordanowt/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-logger-foundation/01-RESEARCH.md
@packages/env/env.ts
@packages/lib/logger.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add DD_LOGS_ENABLED, LOG_LEVEL, and DD_SERVICE to Zod env schema</name>
  <files>packages/env/env.ts</files>
  <action>
Add three new environment variables to the `baseEnv.server` block in `packages/env/env.ts`, immediately after the existing `CHAT_API_TIMEOUT` entry (or at the end of the baseEnv.server block, before the RADAR entries -- group them together with a comment):

```typescript
// Datadog logging configuration
DD_LOGS_ENABLED: boolean.optional().default('false'),
LOG_LEVEL: z
  .enum(['error', 'warn', 'info', 'http', 'verbose', 'debug', 'silly'])
  .optional()
  .default('info'),
DD_SERVICE: z.string().min(1).optional(),
```

Key constraints:
- Use the existing `boolean` helper (line 55) for `DD_LOGS_ENABLED` -- do NOT define a new Zod type.
- All three vars are `optional()` -- they must NOT break existing deployments that do not set them.
- `DD_LOGS_ENABLED` defaults to `'false'` (string, transformed to boolean by the helper).
- `LOG_LEVEL` defaults to `'info'`.
- `DD_SERVICE` has no default (optional with no fallback -- logger.ts handles its own fallback).
- Do NOT add these to the `runtimeEnv` section -- they are server-side only, not client-exposed.
- Do NOT add these to the `client` block.

The existing `onValidationError` callback (line 477-486) already throws with a clear error message when validation fails, so setting `DD_LOGS_ENABLED=invalid` will automatically produce:
`Invalid environment variables: {"DD_LOGS_ENABLED":["Invalid enum value..."]}`

Note: The logger at `packages/lib/logger.ts` reads `process.env.DD_LOGS_ENABLED` directly (raw string) and does NOT import from `@typebot.io/env`. This is correct and must remain unchanged -- the Zod schema validates at app startup independently; the logger's runtime gate (`!== 'true'`) is separate. Do NOT change logger.ts to import env.
  </action>
  <verify>
    <automated>cd /home/giordanowt/Repositories/typebot.io && node -e "
      const fs = require('fs');
      const content = fs.readFileSync('packages/env/env.ts', 'utf8');
      const checks = [
        content.includes('DD_LOGS_ENABLED'),
        content.includes('LOG_LEVEL'),
        content.includes('DD_SERVICE'),
        content.includes('boolean.optional().default'),
        !content.includes('DD_LOGS_ENABLED') || !content.match(/runtimeEnv[^}]*DD_LOGS_ENABLED/s),
      ];
      const allPass = checks.every(Boolean);
      console.log(allPass ? 'PASS: All env vars present, not in runtimeEnv' : 'FAIL');
      process.exit(allPass ? 0 : 1);
    "
    </automated>
    <manual>Verify DD_LOGS_ENABLED, LOG_LEVEL, DD_SERVICE appear in baseEnv.server block and not in runtimeEnv</manual>
  </verify>
  <done>DD_LOGS_ENABLED (using existing boolean helper, optional, default false), LOG_LEVEL (enum of Winston levels, optional, default info), and DD_SERVICE (optional string) are in the Zod server schema. Setting DD_LOGS_ENABLED=invalid causes onValidationError to throw at startup.</done>
</task>

<task type="auto">
  <name>Task 2: Add defaultMeta with ddsource and service to Winston logger</name>
  <files>packages/lib/logger.ts</files>
  <action>
In `packages/lib/logger.ts`, add a `defaultMeta` property to the `winston.createLogger()` call (currently at line 31). The modified createLogger call should be:

```typescript
logger = winston.createLogger({
  level,
  exitOnError: false,
  // Static Datadog pipeline fields -- present on every log entry.
  // Do NOT pass ddsource or service at individual call sites.
  defaultMeta: {
    ddsource: 'nodejs',
    service: process.env.DD_SERVICE ?? 'typebot-runner',
  },
  format: winston.format.combine(
    ...baseFormats,
    prettyEnabled ? prettyFormat : jsonFormat
  ),
  transports: [new winston.transports.Console()],
})
```

Key constraints:
- Add `defaultMeta` immediately after `exitOnError: false,` and before `format:`.
- Use `process.env.DD_SERVICE ?? 'typebot-runner'` -- do NOT import from `@typebot.io/env` (would create circular dependency risk and change initialization order).
- Keep `defaultMeta` to flat string fields ONLY. Do NOT put nested objects (like `workflow.*`) here -- Winston's shallow merge would cause call-site objects to overwrite the entire nested object.
- Include the code comment explaining these are DD pipeline contract fields.
- Do NOT change any other part of the file (console redirects, format chain, level logic, client fallback).
  </action>
  <verify>
    <automated>cd /home/giordanowt/Repositories/typebot.io && node -e "
      const fs = require('fs');
      const content = fs.readFileSync('packages/lib/logger.ts', 'utf8');
      const checks = [
        content.includes('defaultMeta'),
        content.includes(\"ddsource: 'nodejs'\"),
        content.includes(\"service: process.env.DD_SERVICE ?? 'typebot-runner'\"),
        !content.includes('@typebot.io/env'),
      ];
      const allPass = checks.every(Boolean);
      console.log(allPass ? 'PASS: defaultMeta present with correct fields' : 'FAIL');
      process.exit(allPass ? 0 : 1);
    "
    </automated>
    <manual>Verify defaultMeta block in createLogger with ddsource and service fields, no import from env package</manual>
  </verify>
  <done>Winston createLogger call includes defaultMeta with ddsource: 'nodejs' and service: process.env.DD_SERVICE ?? 'typebot-runner'. Every log entry now automatically includes these two static DD pipeline fields without call-site changes.</done>
</task>

</tasks>

<verification>
After both tasks complete, run a quick smoke test to confirm JSON output shape:

```bash
cd /home/giordanowt/Repositories/typebot.io
DD_LOGS_ENABLED=true NODE_ENV=production node -e "
  const logger = require('./packages/lib/logger').default;
  logger.info('smoke test', { test: true });
" 2>&1 | head -1 | node -e "
  const line = require('fs').readFileSync('/dev/stdin', 'utf8').trim();
  const obj = JSON.parse(line);
  const ok = obj.ddsource === 'nodejs' && obj.service === 'typebot-runner' && obj.message === 'smoke test';
  console.log(ok ? 'SMOKE TEST PASS' : 'SMOKE TEST FAIL: ' + JSON.stringify(obj));
  process.exit(ok ? 0 : 1);
"
```

This confirms LOG-01 (single-line JSON) and LOG-02 (ddsource + service present).
</verification>

<success_criteria>
1. packages/env/env.ts contains DD_LOGS_ENABLED, LOG_LEVEL, DD_SERVICE in baseEnv.server block
2. packages/lib/logger.ts createLogger call includes defaultMeta with ddsource and service
3. Running with DD_LOGS_ENABLED=true NODE_ENV=production produces JSON with ddsource: "nodejs" and service: "typebot-runner"
4. Setting DD_LOGS_ENABLED=invalid would trigger Zod validation error at app startup (via onValidationError)
</success_criteria>

<output>
After completion, create `.planning/phases/01-logger-foundation/01-01-SUMMARY.md`
</output>
